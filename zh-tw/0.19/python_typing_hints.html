<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Appendix D: Python typing hints - PyO3 user guide</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="PyO3 user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PyO3 user guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/edit/main/guide/src/python_typing_hints.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="typing-and-ide-hints-for-you-python-package"><a class="header" href="#typing-and-ide-hints-for-you-python-package">Typing and IDE hints for you Python package</a></h1>
<p>PyO3 提供易用介面，可用 Rust 撰寫原生 Python 函式庫。搭配的 Maturin 讓你能將其建置並發布為套件。然而為了更好的使用體驗，Python 函式庫應為所有公開項目提供型別提示與文件，讓 IDE 能在開發時顯示，並讓 <code>mypy</code> 等型別分析工具正確驗證程式碼。</p>
<p>目前最佳的解法是手動維護 <code>*.pyi</code> 檔案，並與套件一同發布。</p>
<p>There is a sketch of a roadmap towards completing <a href="./features.html#experimental-inspect">the <code>experimental-inspect</code> feature</a> which may eventually lead to automatic type annotations generated by PyO3. This needs more testing and implementation, please see <a href="https://github.com/PyO3/pyo3/issues/2454">issue #2454</a>.</p>
<h2 id="pyi-檔案介紹"><a class="header" href="#pyi-檔案介紹"><code>pyi</code> 檔案介紹</a></h2>
<p><code>pyi</code> 檔案（<code>Python Interface</code> 的縮寫）在相關文件中多被稱為「stub 檔案」。對其定義可參考<a href="https://github.com/python/mypy/wiki/Creating-Stubs-For-Python-Modules">舊版 MyPy 文件</a>：</p>
<blockquote>
<p>Stub 檔案只包含模組公開介面的描述，不包含任何實作。</p>
</blockquote>
<p>也可參考<a href="https://typing.readthedocs.io/en/latest/source/stubs.html">官方 Python typing 文件中關於 type stubs 的完整說明</a>。</p>
<p>多數 Python 開發者可能在對內建型別使用 IDE 的「前往定義」功能時就已遇過它們。例如，幾個標準例外的定義如下：</p>
<pre><code class="language-python">class BaseException(object):
    args: Tuple[Any, ...]
    __cause__: BaseException | None
    __context__: BaseException | None
    __suppress_context__: bool
    __traceback__: TracebackType | None
    def __init__(self, *args: object) -&gt; None: ...
    def __str__(self) -&gt; str: ...
    def __repr__(self) -&gt; str: ...
    def with_traceback(self: _TBE, tb: TracebackType | None) -&gt; _TBE: ...

class SystemExit(BaseException):
    code: int

class Exception(BaseException): ...

class StopIteration(Exception):
    value: Any
</code></pre>
<p>如你所見，這些並非包含實作的完整定義，而只是介面描述。這通常已足以滿足函式庫使用者的需求。</p>
<h3 id="pep-有什麼說法"><a class="header" href="#pep-有什麼說法">PEP 有什麼說法？</a></h3>
<p>At the time of writing this documentation, the <code>pyi</code> files are referenced in three PEPs.</p>
<p><a href="https://www.python.org/dev/peps/pep-0008/#function-annotations">PEP8 - Python 程式碼風格指南 - #Function Annotations</a>（最後一點）建議所有第三方函式庫作者提供 stub 檔案，作為型別檢查工具對套件的知識來源。</p>
<blockquote>
<p>（……）預期第三方函式庫的使用者可能會對這些套件執行型別檢查。為此，<a href="https://www.python.org/dev/peps/pep-0484">PEP 484</a> 建議使用 stub 檔案：型別檢查器會優先讀取 .pyi 檔案而不是對應的 .py 檔案。（……）</p>
</blockquote>
<p><a href="https://www.python.org/dev/peps/pep-0484/#stub-files">PEP484 - Type Hints - #Stub Files</a> 對 stub 檔案的定義如下。</p>
<blockquote>
<p>Stub 檔案是只提供給型別檢查器使用、而非執行階段使用的型別提示檔案。</p>
</blockquote>
<p>其中包含對 stub 檔案的規範（強烈建議閱讀，因為至少有一項是一般 Python 程式碼不會用到的）以及關於存放位置的一般資訊。</p>
<p><a href="https://www.python.org/dev/peps/pep-0561/">PEP561 - Distributing and Packaging Type Information</a> 詳細描述如何建置能啟用型別檢查的套件，特別是如何散布 stub 檔案以供型別檢查器使用。</p>
<h2 id="該怎麼做"><a class="header" href="#該怎麼做">該怎麼做？</a></h2>
<p><a href="https://www.python.org/dev/peps/pep-0561/">PEP561</a> 提出三種散布型別資訊的方式：</p>
<ul>
<li><code>inline</code> - 型別直接放在原始碼（<code>py</code>）檔案中；</li>
<li><code>separate package with stub files</code> - 型別放在 <code>pyi</code> 檔案中，並以獨立套件發布；</li>
<li><code>in-package stub files</code> - 型別放在 <code>pyi</code> 檔案中，並與原始碼同套件發布。</li>
</ul>
<p>第一種方式在 PyO3 中較困難，因為我們沒有 <code>py</code> 檔案。待完成研究與必要改動後，本文件將更新。</p>
<p>第二種方式很容易完成，而且可與主函式庫程式碼完全分離。帶有 stub 檔案的套件範例可在 <a href="https://www.python.org/dev/peps/pep-0561/#references">PEP561 參考資料</a>中找到：<a href="https://github.com/ethanhs/stub-package">Stub package repository</a></p>
<p>第三種方式如下所述。</p>
<h3 id="在-pyo3maturin-建置套件中包含-pyi-檔案"><a class="header" href="#在-pyo3maturin-建置套件中包含-pyi-檔案">在 PyO3/Maturin 建置套件中包含 <code>pyi</code> 檔案</a></h3>
<p>當原始碼與 stub 檔案位於同一套件時，應該把它們放在彼此相鄰的位置。我們需要能用 Maturin 達成這點的方法。此外，為了標示套件具有型別資訊，我們需要在套件中新增一個名為 <code>py.typed</code> 的空檔案。</p>
<h4 id="若你沒有其他-python-檔案"><a class="header" href="#若你沒有其他-python-檔案">若你沒有其他 Python 檔案</a></h4>
<p>若除了 <code>pyi</code> 之外不需要加入其他 Python 檔案，Maturin 提供了方法替你完成大部分工作。如同 <a href="https://github.com/PyO3/maturin/#mixed-rustpython-projects">Maturin 指南</a> 所述，你只需在專案根目錄建立名為 <code>&lt;module_name&gt;.pyi</code> 的 stub 檔案，其餘由 Maturin 處理。</p>
<pre><code class="language-text">my-rust-project/
├── Cargo.toml
├── my_project.pyi  # &lt;&lt;&lt; add type stubs for Rust functions in the my_project module here
├── pyproject.toml
└── src
    └── lib.rs
</code></pre>
<p>如需 <code>pyi</code> 範例檔案，請見 <a href="#my_projectpyi-content"><code>my_project.pyi</code> 內容</a> 一節。</p>
<h4 id="if-you-need-other-python-files"><a class="header" href="#if-you-need-other-python-files">If you need other Python files</a></h4>
<p>If you need to add other Python files apart from <code>pyi</code> to the package, you can do it also, but that requires some more work. Maturin provides an easy way to add files to a package (<a href="https://github.com/PyO3/maturin/blob/0dee40510083c03607834c821eea76964140a126/Readme.md#mixed-rustpython-projects">documentation</a>). You just need to create a folder with the name of your module next to the <code>Cargo.toml</code> file (for customization see documentation linked above).</p>
<p>The folder structure would be:</p>
<pre><code class="language-text">my-project
├── Cargo.toml
├── my_project
│   ├── __init__.py
│   ├── my_project.pyi
│   ├── other_python_file.py
│   └── py.typed
├── pyproject.toml
├── Readme.md
└── src
    └── lib.rs
</code></pre>
<p>Let's go a little bit more into detail regarding the files inside the package folder.</p>
<h5 id="__init__py-content"><a class="header" href="#__init__py-content"><code>__init__.py</code> content</a></h5>
<p>As we now specify our own package content, we have to provide the <code>__init__.py</code> file, so the folder is treated as a package and we can import things from it. We can always use the same content that Maturin creates for us if we do not specify a Python source folder. For PyO3 bindings it would be:</p>
<pre><code class="language-python">from .my_project import *
</code></pre>
<p>That way everything that is exposed by our native module can be imported directly from the package.</p>
<h5 id="pytyped-requirement"><a class="header" href="#pytyped-requirement"><code>py.typed</code> requirement</a></h5>
<p>As stated in <a href="https://www.python.org/dev/peps/pep-0561/">PEP561</a>:</p>
<blockquote>
<p>Package maintainers who wish to support type checking of their code MUST add a marker file named py.typed to their package supporting typing. This marker applies recursively: if a top-level package includes it, all its sub-packages MUST support type checking as well.</p>
</blockquote>
<p>If we do not include that file, some IDEs might still use our <code>pyi</code> files to show hints, but the type checkers might not. MyPy will raise an error in this situation:</p>
<pre><code class="language-text">error: Skipping analyzing "my_project": found module but no type hints or library stubs
</code></pre>
<p>The file is just a marker file, so it should be empty.</p>
<h5 id="my_projectpyi-content"><a class="header" href="#my_projectpyi-content"><code>my_project.pyi</code> content</a></h5>
<p>Our module stub file. This document does not aim at describing how to write them, since you can find a lot of documentation on it, starting from the already quoted <a href="https://www.python.org/dev/peps/pep-0484/#stub-files">PEP484</a>.</p>
<p>The example can look like this:</p>
<pre><code class="language-python">class Car:
    """
    A class representing a car.

    :param body_type: the name of body type, e.g. hatchback, sedan
    :param horsepower: power of the engine in horsepower
    """
    def __init__(self, body_type: str, horsepower: int) -&gt; None: ...

    @classmethod
    def from_unique_name(cls, name: str) -&gt; 'Car':
        """
        Creates a Car based on unique name

        :param name: model name of a car to be created
        :return: a Car instance with default data
        """

    def best_color(self) -&gt; str:
        """
        Gets the best color for the car.

        :return: the name of the color our great algorithm thinks is the best for this car
        """
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="trait_bounds.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="changelog.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="trait_bounds.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="changelog.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
