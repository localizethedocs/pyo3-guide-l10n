<!DOCTYPE HTML>
<html lang="zh_TW" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>常見問題與疑難排解 - PyO3 user guide</title>


        <!-- Custom HTML head -->
        <script type="text/javascript" src="ltd-provenance.js"></script>
        <script type="text/javascript" src="ltd-current.js"></script>
        <script type="text/javascript" src="../../ltd-config.js"></script>
        <script type="text/javascript" src="../../ltd-flyout.js"></script>

        <meta name="description" content="PyO3 user guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/tabs.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">PyO3 user guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/PyO3/pyo3/edit/main/guide/src/faq.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="常見問題與疑難排解"><a class="header" href="#常見問題與疑難排解">常見問題與疑難排解</a></h1>
<p>很抱歉你在使用 PyO3 時遇到問題。如果在下列清單中找不到答案，也可以到 <a href="https://github.com/PyO3/pyo3/discussions">GitHub Discussions</a> 或 <a href="https://discord.gg/33kcChzH7f">Discord</a> 尋求協助。</p>
<h2 id="使用-pyo3-搭配-stdsynconcelockstdsynclazylocklazy_static-與-once_cell-時遇到死鎖"><a class="header" href="#使用-pyo3-搭配-stdsynconcelockstdsynclazylocklazy_static-與-once_cell-時遇到死鎖">使用 PyO3 搭配 <code>std::sync::OnceLock</code>、<code>std::sync::LazyLock</code>、<code>lazy_static</code> 與 <code>once_cell</code> 時遇到死鎖</a></h2>
<p><code>OnceLock</code>、<code>LazyLock</code> 以及其第三方前身會透過阻塞來確保只有一個執行緒進行初始化。由於 Python 直譯器可能引入額外鎖（Python 的 GIL 與 GC 都可能要求其他執行緒暫停），因此可能以以下方式造成死鎖：</p>
<ol>
<li>已附著到 Python 直譯器的執行緒（執行緒 A）開始初始化 <code>OnceLock</code> 值。</li>
<li>初始化程式碼呼叫了會暫時與直譯器分離的 Python API，例如 <code>Python::import</code>。</li>
<li>另一個執行緒（執行緒 B）附著到 Python 直譯器並嘗試存取相同的 <code>OnceLock</code> 值。</li>
<li>執行緒 B 被阻塞，因為它在等待 <code>OnceLock</code> 的初始化鎖釋放。</li>
<li>在非自由執行緒的 Python 中，執行緒 A 現在也會被阻塞，因為它等待重新附著到直譯器（必須取得執行緒 B 仍持有的 GIL）。</li>
<li>死鎖。</li>
</ol>
<p>PyO3 provides a struct <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> which implements a single-initialization API based on these types that avoids deadlocks. You can also make use of the <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> and <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/sync/trait.OnceLockExt.html"><code>OnceLockExt</code></a> extension traits that enable using the standard library types for this purpose by providing new methods for these types that avoid the risk of deadlocking with the Python interpreter. This means they can be used in place of other choices when you are experiencing the deadlock described above. See the documentation for <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/sync/struct.PyOnceLock.html"><code>PyOnceLock</code></a> and <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/sync/trait.OnceExt.html"><code>OnceExt</code></a> for further details and an example how to use them.</p>
<h2 id="無法執行-cargo-test或在-cargo-workspace-中無法建置遇到連結器錯誤如symbol-not-found或undefined-reference-to-_pyexc_systemerror"><a class="header" href="#無法執行-cargo-test或在-cargo-workspace-中無法建置遇到連結器錯誤如symbol-not-found或undefined-reference-to-_pyexc_systemerror">無法執行 <code>cargo test</code>；或在 Cargo workspace 中無法建置：遇到連結器錯誤如「Symbol not found」或「Undefined reference to _PyExc_SystemError」</a></h2>
<p>Currently, <a href="https://github.com/PyO3/pyo3/issues/340">#340</a> causes <code>cargo test</code> to fail with linking errors when the <code>extension-module</code> feature is activated. Linking errors can also happen when building in a cargo workspace where a different crate also uses PyO3 (see <a href="https://github.com/PyO3/pyo3/issues/2521">#2521</a>). For now, there are three ways we can work around these issues.</p>
<ol>
<li>
<p>Make the <code>extension-module</code> feature optional. Build with <code>maturin develop --features "extension-module"</code></p>
<pre><code class="language-toml">[dependencies.pyo3]
{{#PYO3_CRATE_VERSION}}

[features]
extension-module = ["pyo3/extension-module"]
</code></pre>
</li>
<li>
<p>Make the <code>extension-module</code> feature optional and default. Run tests with <code>cargo test --no-default-features</code>:</p>
<pre><code class="language-toml">[dependencies.pyo3]
{{#PYO3_CRATE_VERSION}}

[features]
extension-module = ["pyo3/extension-module"]
default = ["extension-module"]
</code></pre>
</li>
<li>
<p>If you are using a <a href="https://maturin.rs/metadata.html"><code>pyproject.toml</code></a> file to control maturin settings, add the following section:</p>
<pre><code class="language-toml">[tool.maturin]
features = ["pyo3/extension-module"]
# Or for maturin 0.12:
# cargo-extra-args = ["--features", "pyo3/extension-module"]
</code></pre>
</li>
</ol>
<h2 id="無法執行-cargo-testtests-目錄中的測試找不到我的-crate"><a class="header" href="#無法執行-cargo-testtests-目錄中的測試找不到我的-crate">無法執行 <code>cargo test</code>：<code>tests/</code> 目錄中的測試找不到我的 crate</a></h2>
<p>Rust 書籍建議<a href="https://doc.rust-lang.org/book/ch11-03-test-organization.html#integration-tests">將整合測試放在 <code>tests/</code> 目錄中</a>。</p>
<p>For a PyO3 <code>extension-module</code> project where the <code>crate-type</code> is set to <code>"cdylib"</code> in your <code>Cargo.toml</code>, the compiler won't be able to find your crate and will display errors such as <code>E0432</code> or <code>E0463</code>:</p>
<pre><code class="language-text">error[E0432]: unresolved import `my_crate`
 --&gt; tests/test_my_crate.rs:1:5
  |
1 | use my_crate;
  |     ^^^^^^^^^^^^ no external crate `my_crate`
</code></pre>
<p>最佳解法是讓 crate 型別同時包含 <code>rlib</code> 與 <code>cdylib</code>：</p>
<pre><code class="language-toml"># Cargo.toml
[lib]
crate-type = ["cdylib", "rlib"]
</code></pre>
<h2 id="在-rust-程式碼執行期間按-ctrl-c-沒有效果"><a class="header" href="#在-rust-程式碼執行期間按-ctrl-c-沒有效果">在 Rust 程式碼執行期間按 Ctrl-C 沒有效果</a></h2>
<p>這是因為 Ctrl-C 會送出 SIGINT 訊號，呼叫端 Python 程序只會設定一個旗標以便稍後處理。當 Python 呼叫的 Rust 程式碼執行中時，不會檢查此旗標，直到控制權回到 Python 直譯器才會處理。</p>
<p>你可以呼叫 <code>Python::check_signals</code> 讓 Python 直譯器有機會正確處理訊號。若你的 Rust 函式會長時間執行，建議定期呼叫此函式，讓使用者能取消。</p>
<h2 id="pyo3get-會複製我的欄位"><a class="header" href="#pyo3get-會複製我的欄位"><code>#[pyo3(get)]</code> 會複製我的欄位</a></h2>
<p>你可能有如下的巢狀結構：</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
#[derive(Clone)]
struct Inner {/* fields omitted */}

#[pyclass]
struct Outer {
    #[pyo3(get)]
    inner: Inner,
}

#[pymethods]
impl Outer {
    #[new]
    fn __new__() -&gt; Self {
        Self { inner: Inner {} }
    }
}</code></pre>
<p>當 Python 程式碼存取 <code>Outer</code> 的欄位時，PyO3 會在每次存取時回傳新的物件（注意位址不同）：</p>
<pre><code class="language-python">outer = Outer()

a = outer.inner
b = outer.inner

assert a is b, f"a: {a}\nb: {b}"
</code></pre>
<pre><code class="language-text">AssertionError: a: &lt;builtins.Inner object at 0x00000238FFB9C7B0&gt;
b: &lt;builtins.Inner object at 0x00000238FFB9C830&gt;
</code></pre>
<p>若欄位是可變的，這會特別令人困惑，因為取得欄位後再修改並不會持久化——下次存取只會拿到原始物件的新複本。不幸的是，Python 與 Rust 對所有權的理解不同——如果 PyO3 將（可能是暫時的）Rust 物件參照交給 Python，Python 可能會無限期保留該參照。因此回傳 Rust 物件需要進行複製。</p>
<p>If you don't want that cloning to happen, a workaround is to allocate the field on the Python heap and store a reference to that, by using <a href="%7B%7B#PYO3_DOCS_URL%7D%7D/pyo3/struct.Py.html"><code>Py&lt;...&gt;</code></a>:</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span>#[pyclass]
struct Inner {/* fields omitted */}

#[pyclass]
struct Outer {
    inner: Py&lt;Inner&gt;,
}

#[pymethods]
impl Outer {
    #[new]
    fn __new__(py: Python&lt;'_&gt;) -&gt; PyResult&lt;Self&gt; {
        Ok(Self {
            inner: Py::new(py, Inner {})?,
        })
    }

    #[getter]
    fn inner(&amp;self, py: Python&lt;'_&gt;) -&gt; Py&lt;Inner&gt; {
        self.inner.clone_ref(py)
    }
}</code></pre>
<p>This time <code>a</code> and <code>b</code> <em>are</em> the same object:</p>
<pre><code class="language-python">outer = Outer()

a = outer.inner
b = outer.inner

assert a is b, f"a: {a}\nb: {b}"
print(f"a: {a}\nb: {b}")
</code></pre>
<pre><code class="language-text">a: &lt;builtins.Inner object at 0x0000020044FCC670&gt;
b: &lt;builtins.Inner object at 0x0000020044FCC670&gt;
</code></pre>
<p>The downside to this approach is that any Rust code working on the <code>Outer</code> struct potentially has to attach to the Python interpreter to do anything with the <code>inner</code> field. (If <code>Inner</code> is <code>#[pyclass(frozen)]</code> and implements <code>Sync</code>, then <code>Py::get</code> may be used to access the <code>Inner</code> contents from <code>Py&lt;Inner&gt;</code> without needing to attach to the interpreter.)</p>
<h2 id="i-want-to-use-the-pyo3-crate-re-exported-from-dependency-but-the-proc-macros-fail"><a class="header" href="#i-want-to-use-the-pyo3-crate-re-exported-from-dependency-but-the-proc-macros-fail">I want to use the <code>pyo3</code> crate re-exported from dependency but the proc-macros fail</a></h2>
<p>All PyO3 proc-macros (<code>#[pyclass]</code>, <code>#[pyfunction]</code>, <code>#[derive(FromPyObject)]</code> and so on) expect the <code>pyo3</code> crate to be available under that name in your crate root, which is the normal situation when <code>pyo3</code> is a direct dependency of your crate.</p>
<p>However, when the dependency is renamed, or your crate only indirectly depends on <code>pyo3</code>, you need to let the macro code know where to find the crate.  This is done with the <code>crate</code> attribute:</p>
<pre><code class="language-rust no_run"><span class="boring">use pyo3::prelude::*;
</span><span class="boring">pub extern crate pyo3;
</span><span class="boring">mod reexported { pub use ::pyo3; }
</span><span class="boring">#[allow(dead_code)]
</span>#[pyclass]
#[pyo3(crate = "reexported::pyo3")]
struct MyClass;</code></pre>
<h2 id="im-trying-to-call-python-from-rust-but-i-get-status_dll_not_found-or-status_entrypoint_not_found"><a class="header" href="#im-trying-to-call-python-from-rust-but-i-get-status_dll_not_found-or-status_entrypoint_not_found">I'm trying to call Python from Rust but I get <code>STATUS_DLL_NOT_FOUND</code> or <code>STATUS_ENTRYPOINT_NOT_FOUND</code></a></h2>
<p>This happens on Windows when linking to the python DLL fails or the wrong one is linked. The Python DLL on Windows will usually be called something like:</p>
<ul>
<li><code>python3X.dll</code> for Python 3.X, e.g. <code>python310.dll</code> for Python 3.10</li>
<li><code>python3.dll</code> when using PyO3's <code>abi3</code> feature</li>
</ul>
<p>The DLL needs to be locatable using the <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#standard-search-order-for-unpackaged-apps">Windows DLL search order</a>. Some ways to achieve this are:</p>
<ul>
<li>Put the Python DLL in the same folder as your build artifacts</li>
<li>Add the directory containing the Python DLL to your <code>PATH</code> environment variable, for example <code>C:\Users\&lt;You&gt;\AppData\Local\Programs\Python\Python310</code></li>
<li>If this happens when you are <em>distributing</em> your program, consider using <a href="https://github.com/indygreg/PyOxidizer">PyOxidizer</a> to package it with your binary.</li>
</ul>
<p>If the wrong DLL is linked it is possible that this happened because another program added itself and its own Python DLLs to <code>PATH</code>. Rearrange your <code>PATH</code> variables to give the correct DLL priority.</p>
<blockquote>
<p><strong>Note</strong>: Changes to <code>PATH</code> (or any other environment variable) are not visible to existing shells. Restart it for changes to take effect.</p>
</blockquote>
<p>For advanced troubleshooting, <a href="https://www.dependencywalker.com/">Dependency Walker</a> can be used to diagnose linking errors.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ecosystem/async-await.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="migration.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ecosystem/async-await.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="migration.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="theme/tabs.js"></script>



    </div>
    </body>
</html>
